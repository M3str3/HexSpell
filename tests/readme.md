# HexSpell - Testing System

## Overview

The **HexSpell** project is a Rust library designed to parse various binary formats, including PE, ELF, and Mach-O. The testing framework for this project is crucial to ensure the accuracy and reliability of the parsing functions. This document will guide you through the structure of the testing system, how to add new tests, and how to manually generate and validate the necessary TOML configuration files.

## Directory Structure

Here is the structure of the `tests` directory:

```
├───out
├───samples
├───scripts
└───source
```

### Key Directories and Files

- **scripts/generator.py**: This script generates a preliminary `tests.toml` file, which contains the expected values for various binary formats. However, the results generated by this script should be manually reviewed and validated to ensure accuracy, as the quality of the library depends on the correctness of this data.

- **pe.rs, elf.rs, macho.rs**: These files contain the Rust test cases for parsing PE, ELF, and Mach-O binaries, respectively. They utilize the data defined in `tests.toml` to verify the correctness of the parsed output.

- **tests.toml**: A TOML file that defines the expected structure of the binaries. This file is auto-generated by `generator.py` but requires manual validation to ensure the integrity of the test cases.

- **samples/**: This directory contains the binary files used for testing. Each binary corresponds to a format (PE, ELF, Mach-O) and is referenced in the tests.

- **out/**: This directory is used to store modified binaries after running certain tests, such as shellcode injection.

- **source/**: Contains the source code (C/C++) of the binaries found in the `samples/` directory.

## Generating the `tests.toml` File

The `tests.toml` file is central to the testing process as it defines the expected outcomes for each binary parsed by the library. To generate or update this file, use the `generator.py` script:

```sh
python tests/scripts/generator.py -i samples/ -o tests.toml
```


### Key Directories and Files

- **scripts/generator.py**: This script generates the `tests.toml` file, which contains the expected values for various binary formats. These values are used to validate the parsing results.

- **pe.rs, elf.rs, macho.rs**: These files contain the Rust test cases for parsing PE, ELF, and Mach-O binaries, respectively.

- **tests.toml**: A TOML file that defines the expected structure of the binaries. This file is auto-generated by `generator.py` and is crucial for verifying that the parser works correctly.

- **samples/**: This directory contains the binary files used for testing. Each binary corresponds to a format (PE, ELF, Mach-O) and is referenced in the tests.

- **out/**: This directory is used to store modified binaries after running certain tests, such as shellcode injection.

- **source/**: Contains the source code (C/C++) of the binaries found in the `samples/` directory.

## Generating the `tests.toml` File

The `tests.toml` file is central to the testing process as it defines the expected outcomes for each binary parsed by the library. To generate or update this file, use the `generator.py` script:

```sh
python3 scripts/generator.py -i samples/ -o tests.toml
```

## Script Options
* -i, --input: Specifies the directory containing the binaries to analyze. The default is samples/.
* -o, --output: Specifies the output file for the generated TOML. The default is tests.toml.
* -d, --debug: Enables verbose debug output.

## Manual Validation
After generating the tests.toml file with the script, it is crucial to manually review the generated values. Ensure that the fields in tests.toml accurately reflect the expected structure and content of the binaries. This step is essential for maintaining the high quality and reliability of the HexSpell library.

## Running Tests
To run the tests, simply use the following command in your Rust project's root directory:
```sh
cargo test
```

This command will execute all the tests defined in `pe.rs`, `elf.rs`, and `macho.rs`, comparing the parsed values against those defined in `tests.toml`.

## Adding New Tests
1. Add New Binaries: Place the new binary files in the samples/ directory.

2. Generate or Update tests.toml: Run generator.py to generate the corresponding entries in tests.toml.

3. Write Test Cases: Modify or add test cases in `pe.rs`, `elf.rs`, or `macho.rs` to include the new binaries. Ensure the test cases reference the correct keys in `tests.toml`.

4. Run Tests: Execute cargo test to ensure everything works as expected.

## Contributing
When contributing to the testing framework, ensure that:

- New tests are clearly documented.
- Any modifications to the generator.py script or tests.toml format are well-explained.
- All tests pass before submitting a pull request.

For any questions or clarifications, feel free to open an issue or reach out to the project maintainers.

